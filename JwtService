package com.example.jwtmock.service;

import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import javax.annotation.PostConstruct;
import java.security.KeyFactory;
import java.security.PrivateKey;
import java.security.spec.PKCS8EncodedKeySpec;
import java.util.*;

@Service
public class JwtMockService {

    @Value("${jwt.private-key}")
    private String privateKeyBase64; // PKCS#8 DER bytes -> base64 (one-liner)

    @Value("${jwt.expiration}")
    private long expirationMs; // milliseconds

    private PrivateKey privateKey;

    @PostConstruct
    public void init() throws Exception {
        if (privateKeyBase64 == null || privateKeyBase64.trim().isEmpty()) {
            throw new IllegalStateException("jwt.private-key is not set in application.properties");
        }
        byte[] keyBytes = Base64.getDecoder().decode(privateKeyBase64.trim());
        PKCS8EncodedKeySpec spec = new PKCS8EncodedKeySpec(keyBytes);
        KeyFactory kf = KeyFactory.getInstance("RSA");
        this.privateKey = kf.generatePrivate(spec);
    }

    public String generateToken(String username) {
        long nowMillis = System.currentTimeMillis();
        long expMillis = nowMillis + expirationMs;
        long nowSec = nowMillis / 1000L;
        long expSec = expMillis / 1000L;

        Map<String, Object> header = new HashMap<>();
        header.put("typ", "JWT");
        header.put("kid", "E2E_TRUST_SAML_CMB_UAT");
        header.put("alg", "RS256");
        header.put("sch", "urn:aim:token:internal");
        header.put("scv", "1.0");
        header.put("tkv", "1.0");

        Map<String, Object> claims = new HashMap<>();
        claims.put("sub", username);
        claims.put("grp", defaultGroups());
        claims.put("iss", "cmbdsp.uk.hsbc.com");
        claims.put("iat", nowSec);
        claims.put("exp", expSec);
        claims.put("jti", UUID.randomUUID().toString());
        claims.put("sit", "ad:svc:principal");

        return Jwts.builder()
                .setHeader(header)
                .setClaims(claims)
                .signWith(privateKey, SignatureAlgorithm.RS256)
                .compact();
    }

    private List<String> defaultGroups() {
        return Arrays.asList(
                "CN=InfoDir-CB-RPS-NVP-DEV, OU=HBEU, OU=CB_RPS, OU=Applications, OU=Groups, DC=InfoDir, DC=Prod, DC=HSBC",
                "CN=infodir-MyWorkspace-UK-Bereavement-DEV-BR, OU=UK, OU=HBEU, OU=Bereavement, OU=MyWorkspace, OU=Applications, OU=Groups, DC=InfoDir, DC=Prod, DC=HSBC",
                "CN=InfoDir-RBWM-UKB-RPS-CI-DEV, OU=HBEU, OU=RBWM-UKB-RPS-CI, OU=Applications, OU=Groups, DC=InfoDir, DC=Prod, DC=HSBC"
        );
    }
}
